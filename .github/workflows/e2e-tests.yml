name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  DATABASE_URL: ${{ secrets.POSTGRES_URL }}
  POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
  POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
  POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
  POSTGRES_DATABASE: ${{ secrets.POSTGRES_DATABASE }}
  HAKAPIT_RSS: ${{ secrets.HAKAPIT_RSS }}
  NITK_RSS: ${{ secrets.NITK_RSS }}
  BALCONY_RSS: ${{ secrets.BALCONY_RSS }}
  FOOTBALL_DATA_API_KEY: ${{ secrets.FOOTBALL_DATA_API_KEY }}
  NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}
  VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
  API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
  GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
  SPORTMONKS_API_KEY: ${{ secrets.SPORTMONKS_API_KEY }}

jobs:
  e2e-tests:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        # Test on Chrome only for faster CI
        browser: [chromium]
        # Test on desktop and mobile viewports
        viewport: [desktop, mobile]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Get Bun cache directory
      id: bun-cache-dir
      run: |
        echo "dir=$(bun pm cache dir)" >> $GITHUB_OUTPUT
        
    - name: Cache Bun dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.bun-cache-dir.outputs.dir }}
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-bun-
          
    - name: Install dependencies
      run: bun install --frozen-lockfile
      
    - name: Cache Next.js
      uses: actions/cache@v4
      with:
        path: |
          ~/.bun/install/cache
          ${{ github.workspace }}/.next/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
        restore-keys: |
          ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}-
          
    - name: Cache Playwright browsers
      uses: actions/cache@v3
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/playwright.config.ts') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
          
    - name: Install Playwright browsers
      run: bunx playwright install --with-deps ${{ matrix.browser }}
      
    - name: Build application
      uses: nick-fields/retry@v2
      with:
        timeout_minutes: 15
        max_attempts: 3
        retry_on: error
        command: bun run build
      
    - name: Set viewport size
      run: |
        if [ "${{ matrix.viewport }}" = "mobile" ]; then
          echo "PLAYWRIGHT_VIEWPORT_WIDTH=375" >> $GITHUB_ENV
          echo "PLAYWRIGHT_VIEWPORT_HEIGHT=667" >> $GITHUB_ENV
        else
          echo "PLAYWRIGHT_VIEWPORT_WIDTH=1280" >> $GITHUB_ENV
          echo "PLAYWRIGHT_VIEWPORT_HEIGHT=720" >> $GITHUB_ENV
        fi
        
    - name: Run E2E tests
      uses: nick-fields/retry@v2
      with:
        timeout_minutes: 50
        max_attempts: 3
        retry_on: error
        command: bunx playwright test --project=${{ matrix.browser }} --reporter=json --reporter=html --output-dir=test-results-${{ matrix.viewport }}
      env:
        CI: true
        
    - name: Parse test results
      if: always()
      run: |
        node -e "
        const fs = require('fs');
        const report = JSON.parse(fs.readFileSync('test-results-${{ matrix.viewport }}/results.json', 'utf8'));
        const passed = report.suites.reduce((acc, suite) => acc + suite.specs.filter(spec => spec.ok).length, 0);
        const failed = report.suites.reduce((acc, suite) => acc + suite.specs.filter(spec => !spec.ok).length, 0);
        const total = passed + failed;
        const percentage = total > 0 ? Math.round((passed / total) * 100) : 0;
        
        fs.writeFileSync('test-results-${{ matrix.viewport }}/test-summary.json', JSON.stringify({
          passed,
          failed,
          total,
          percentage,
          viewport: '${{ matrix.viewport }}'
        }, null, 2));
        
        console.log('Test Summary:');
        console.log('Passed:', passed);
        console.log('Failed:', failed);
        console.log('Total:', total);
        console.log('Success Rate:', percentage + '%');
        "
        
    - name: Install accessibility dependencies
      if: matrix.viewport == 'desktop' && github.event_name == 'pull_request'
      run: bun add -D @axe-core/playwright
      
    - name: Run accessibility tests
      if: matrix.viewport == 'desktop' && github.event_name == 'pull_request'
      run: bunx playwright test --grep="accessibility" --project=chromium
      env:
        CI: true
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.browser }}-${{ matrix.viewport }}
        path: playwright-report/
        retention-days: 7
        
    - name: Upload accessibility results
      uses: actions/upload-artifact@v4
      if: matrix.viewport == 'desktop' && github.event_name == 'pull_request' && always()
      with:
        name: accessibility-test-results
        path: playwright-report/
        retention-days: 7
        
    - name: Upload test screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: screenshots-${{ matrix.browser }}-${{ matrix.viewport }}
        path: test-results/
        retention-days: 7
        
    - name: Upload test videos
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: videos-${{ matrix.browser }}-${{ matrix.viewport }}
        path: test-results/
        retention-days: 7

  # Generate and update test badges
  update-badges:
    needs: [e2e-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: Generate test badges
      run: |
        # Collect all test results
        total_passed=0
        total_failed=0
        total_tests=0
        
        for viewport in desktop mobile; do
          if [ -f "artifacts/test-results-${viewport}/test-summary.json" ]; then
            passed=$(cat "artifacts/test-results-${viewport}/test-summary.json" | jq -r '.passed')
            failed=$(cat "artifacts/test-results-${viewport}/test-summary.json" | jq -r '.failed')
            total=$((passed + failed))
            
            total_passed=$((total_passed + passed))
            total_failed=$((total_failed + failed))
            total_tests=$((total_tests + total))
          fi
        done
        
        # Calculate success rate
        if [ $total_tests -gt 0 ]; then
          success_rate=$(( (total_passed * 100) / total_tests ))
        else
          success_rate=0
        fi
        
        echo "Total Tests: $total_tests"
        echo "Passed: $total_passed"
        echo "Failed: $total_failed"
        echo "Success Rate: ${success_rate}%"
        
        # Generate badge colors based on success rate
        if [ $success_rate -ge 90 ]; then
          color="brightgreen"
        elif [ $success_rate -ge 75 ]; then
          color="green"
        elif [ $success_rate -ge 60 ]; then
          color="yellow"
        else
          color="red"
        fi
        
        # Create badge SVG
        cat > badges/e2e-tests.svg << EOF
        <svg xmlns="http://www.w3.org/2000/svg" width="120" height="20">
          <linearGradient id="b" x2="0" y2="100%">
            <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
            <stop offset="1" stop-opacity=".1"/>
          </linearGradient>
          <mask id="a">
            <rect width="120" height="20" rx="3" fill="#fff"/>
          </mask>
          <g mask="url(#a)">
            <path fill="#555" d="M0 0h55v20H0z"/>
            <path fill="$color" d="M55 0h65v20H55z"/>
            <path fill="url(#b)" d="M0 0h120v20H0z"/>
          </g>
          <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
            <text x="27.5" y="15" fill="#010101" fill-opacity=".3">E2E Tests</text>
            <text x="27.5" y="14">E2E Tests</text>
            <text x="87.5" y="15" fill="#010101" fill-opacity=".3">${total_passed}/${total_tests}</text>
            <text x="87.5" y="14">${total_passed}/${total_tests}</text>
          </g>
        </svg>
        EOF
        
        # Create coverage badge (using success rate as proxy)
        cat > badges/coverage.svg << EOF
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="20">
          <linearGradient id="b" x2="0" y2="100%">
            <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
            <stop offset="1" stop-opacity=".1"/>
          </linearGradient>
          <mask id="a">
            <rect width="100" height="20" rx="3" fill="#fff"/>
          </mask>
          <g mask="url(#a)">
            <path fill="#555" d="M0 0h60v20H0z"/>
            <path fill="$color" d="M60 0h40v20H60z"/>
            <path fill="url(#b)" d="M0 0h100v20H0z"/>
          </g>
          <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
            <text x="30" y="15" fill="#010101" fill-opacity=".3">Coverage</text>
            <text x="30" y="14">Coverage</text>
            <text x="80" y="15" fill="#010101" fill-opacity=".3">${success_rate}%</text>
            <text x="80" y="14">${success_rate}%</text>
          </g>
        </svg>
        EOF
        
    - name: Commit and push badges
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add badges/
        git commit -m "Update test badges - $(date)" || exit 0
        git push

  
  # Notify on failure
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: failure()
    
    steps:
    - name: Notify on failure
      run: |
        echo "E2E tests failed on ${{ github.repository }}"
        echo "Check the GitHub Actions tab for detailed results"
        # You could add Slack/Discord notifications here
